<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Investment</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
</head>
<body>
    <h1>Stock Investment</h1>

    <h2>Sign Up</h2>
    <form id="signUpForm">
        <label for="email">Email:</label>
        <input type="text" id="signUpemail" name="email" autocomplete="email"><br>
        
        <label for="password">Password:</label>
        <input type="password" id="signUppassword" name="password" required><br>

        <label for="name">Name:</label>
        <input type="text" id="name" name="name" autocomplete="name"><br>

        <button type="button" onclick="signUp()">Sign Up</button>
    </form>

    <hr>

    <h2>Login</h2>
    <form id="loginForm">
        <label for="email">Email:</label>
        <input type="text" id="email" name="email" autocomplete="email"><br>
        
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" required><br>

        <button type="button" onclick="login()">Login</button>
    </form>

    <hr>

    <h2>Buy Stock</h2>
    <form id="buyStockForm">
      <label for="symbol">Symbol:</label>
      <input type="text" id="symbol" name="symbol" required><br>
  
      <label for="amount">Amount:</label>
      <input type="text" id="amount" name="amount" required><br>
  
      <label for="cost">Cost:</label>
      <input type="text" id="cost" name="cost" required><br>
  
      <!-- Portfolio ID'yi integer olarak alacak bir input ekleyin -->
      <label for="buyportfolioId">Portfolio ID:</label>
      <input type="text" id="buyportfolioId" name="portfolioId" required><br>
  
      <button type="button" onclick="buyStock()">Buy Stock</button>
    </form>

    <hr>

    <h2>Portfolio</h2>
    <form id="portfolioForm">
        <label for="portfolioId2">Portfolio ID:</label>
        <input type="text" id="portfolioId2" name="portfolioId2" required><br>

        <button type="button" onclick="getPortfolio()">Get Portfolio</button>
    </form>
    <h2>Profit History</h2>
    <!-- Profit History için yeni bir canvas ekleniyor -->
    <canvas id="profitHistoryChart" width="800" height="400"></canvas>

    <script>
        async function signUp() {
            const signUpForm = document.getElementById("signUpForm");
            const formData = new FormData(signUpForm);

            const response = await fetch('http://127.0.0.1:5000/signUp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(Object.fromEntries(formData)),
            });

            const result = await response.json();
            displayResult(result);

        }

        async function login() {
            const loginForm = document.getElementById("loginForm");
            const formData = new FormData(loginForm);

            const response = await fetch('http://127.0.0.1:5000/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(Object.fromEntries(formData)),
            });
            const result = await response.json();
            console.log(result);

            if(result['isSuccesful'] == true)
              document.cookie = `${result['token']}`;


            displayResult(result);
        }

        async function buyStock() {
            const buyStockForm = document.getElementById("buyStockForm");
            const formData = new FormData(buyStockForm);

            console.log(document.cookie)
            const response = await fetch('http://127.0.0.1:5000/buyStock', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer '+ document.cookie, // Replace with your actual access token
                },
                body: JSON.stringify({
                    portfolioId: parseInt(formData.get('portfolioId')),
                    symbol: formData.get('symbol'),
                    amount: parseInt(formData.get('amount')),
                    cost: parseFloat(formData.get('cost')),
                }),
            });

            const result = await response.json();

            displayResult(result);
            event.preventDefault();
        }

        async function getPortfolio() {
            const portfolioForm = document.getElementById("portfolioForm");
            const formData = new FormData(portfolioForm);

            const response = await fetch('http://127.0.0.1:5000/portfolio', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer '+document.cookie, // Replace with your actual access token
                },
                body: JSON.stringify({
                    portfolioId: parseInt(formData.get('portfolioId2')),
                }),
            });

            const result = await response.json();
            getProfitHistory();
            displayResult(result);

        }

        async function getProfitHistory(){
            const portfolioForm = document.getElementById("portfolioForm");
            const formData = new FormData(portfolioForm);

            const response = await fetch('http://127.0.0.1:5000/profitHistory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer '+document.cookie, // Replace with your actual access token
                },
                body: JSON.stringify({
                    portfolioId: parseInt(formData.get('portfolioId2')),
                }),
            });

            const result = await response.json();

            stock_profits = []

            for (let i = 0; i < result["stocks"].length; i++) {
                stock_profits.push(result["stocks"][i]["profits"]);
            }
            
            var maxLengthArray = stock_profits.reduce(function (acc, currentArray) {
                return currentArray.length > acc.length ? currentArray : acc;
                }, []);
            
            //var openPositions = new Array(result["openPositions"])

            var datasets = []
            for (let index = 0; index < result["stocks"].length; index++) {
                var newArray = []
                var profits = result["stocks"][index]["profits"].map(entry => entry.profit);
                if(result["stocks"][index]["profits"].length < maxLengthArray.length)
                    newArray = new Array(maxLengthArray.length - result["stocks"][index]["profits"].length).fill(null);

                profits.unshift(...newArray);

                var graphData = {
                        label: result["stocks"][index].symbol,
                        data: profits,
                        borderColor: getRandomRGBA(),
                        borderWidth: 5,
                        fill: false,
                    };

                datasets.push(graphData);      
            } 
            
            var dates = maxLengthArray.map(entry => entry.date);
            /*
            var openPositionsData = {
                        label: "Open Positions",
                        data: openPositions.map(entry => entry.profit),
                        borderColor: rgba(0,0,0,1),
                        borderWidth: 5,
                        fill: false,
                    };

            datasets.push(openPositionsData);
                    */
            const profitHistoryChart = new Chart("profitHistoryChart", {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    tooltips: {
                        mode: 'index',
                        intersect: false,
                        bodyFontSize: 24,
                        titleFontSize: 24,
                        callbacks: {
                            title: function (tooltipItems, data) {
                                // Başlık için özel işlemler
                                return tooltipItems[0].xLabel; // Tarih
                            },
                            label: function (tooltipItem, data) {
                                var datasetLabel = data.datasets[tooltipItem.datasetIndex].label || '';
                                return datasetLabel+": " + tooltipItem.yLabel;
                            },
                        },
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            }
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function displayResult(result) {
          const resultDiv = document.getElementById("resultDiv");

          // Eğer resultDiv henüz oluşturulmamışsa, yeni bir div oluşturup ekleyin.
          if (!resultDiv) {
              const newResultDiv = document.createElement("div");
              newResultDiv.id = "resultDiv";

              // JSON.stringify ile JSON nesnesini düz bir dizeye çevirin.
              const jsonString = JSON.stringify(result, null, 2);

              // Her bir JSON satırını yeni bir paragraf içinde ekleyin.
              jsonString.split('\n').forEach((line) => {
                  const paragraph = document.createElement("p");
                  paragraph.textContent = line;
                  newResultDiv.appendChild(paragraph);
              });

              document.body.appendChild(newResultDiv);
            } else {
              // Eğer resultDiv zaten varsa, içeriğini temizler ve güncellenmiş JSON satırlarını ekler.
              resultDiv.textContent = '';

              // JSON.stringify ile JSON nesnesini düz bir dizeye çevirin.
              const jsonString = JSON.stringify(result, null, 2);

              // Her bir JSON satırını yeni bir paragraf içinde ekleyin.
              jsonString.split('\n').forEach((line) => {
                  const paragraph = document.createElement("p");
                  paragraph.textContent = line;
                  resultDiv.appendChild(paragraph);
              });
          }
        }
        function getRandomRGBA() {
            var r = Math.floor(Math.random() * 256);
            var g = Math.floor(Math.random() * 256);
            var b = Math.floor(Math.random() * 256);
            var a = 1

            return `rgba(${r}, ${g}, ${b}, ${a})`;
        }
    </script>
</body>
</html>
